@using OptionA.Tuner.Models
@namespace OptionA.Tuner.Components

<div class="string-indicator">
    @foreach (var str in Instrument.Strings.Reverse())
    {
        var isClosest = IsActive && CurrentNote is not null && IsNearestString(str);

        <div class="string-button @(isClosest ? "closest" : "")"
             title="@str.DisplayName (@str.GetFrequency(ReferenceA4).ToString("F1") Hz)">
            <span class="string-note">@str.Name</span>
            <span class="string-octave">@str.Octave</span>
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired] public InstrumentDefinition Instrument { get; set; } = default!;
    [Parameter] public NoteInfo? CurrentNote { get; set; }
    [Parameter] public bool IsActive { get; set; }
    [Parameter] public double ReferenceA4 { get; set; } = 440.0;

    private bool IsNearestString(StringDefinition str)
    {
        if (CurrentNote is null) return false;

        var detectedMidi = CurrentNote.MidiNote;
        StringDefinition? nearest = null;
        var smallestDistance = int.MaxValue;

        foreach (var s in Instrument.Strings)
        {
            var distance = Math.Abs(s.MidiNote - detectedMidi);
            if (distance < smallestDistance)
            {
                smallestDistance = distance;
                nearest = s;
            }
        }

        return nearest is not null && nearest.MidiNote == str.MidiNote;
    }
}

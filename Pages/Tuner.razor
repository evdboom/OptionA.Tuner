@page "/"
@using OptionA.Tuner.Components
@using OptionA.Tuner.Models
@using OptionA.Tuner.Services
@inject AudioCaptureService AudioCapture
@inject LocalStorageService LocalStorage
@implements IDisposable

<div class="tuner-container">
    <header class="tuner-header">
        <div class="header-brand">
            <img src="logo.svg" alt="OptionA Tuner" class="header-logo" />
            <h1>OptionA Tuner</h1>
        </div>
        <div class="controls-row">
            <div class="control-group">
                <label>Instrument</label>
                <InstrumentPicker SelectedName="@SelectedInstrumentName"
                                  SelectedNameChanged="OnInstrumentPickerChanged" />
            </div>
            <div class="control-group">
                <label>A4 Reference</label>
                <div class="pitch-selector">
                    <button class="pitch-btn" @onclick="DecrementPitch" disabled="@(!CanDecrementPitch)">âˆ’</button>
                    <span class="pitch-value">@ReferenceA4 Hz</span>
                    <button class="pitch-btn" @onclick="IncrementPitch" disabled="@(!CanIncrementPitch)">+</button>
                </div>
            </div>
        </div>
    </header>

    <main class="tuner-main">
        @if (!_isSupported)
        {
            <div class="error-message">
                <p>âš  Your browser does not support microphone access.</p>
                <p>Please use a modern browser (Chrome, Firefox, Edge, Safari).</p>
            </div>
        }
        else
        {
            <NoteDisplay Note="_currentNote" IsActive="_isDetecting" />

            <TuningGauge CentsOffset="@_smoothedCents" IsActive="_isDetecting" />

            <StringIndicator Instrument="_selectedInstrument"
                             CurrentNote="_currentNote"
                             IsActive="_isDetecting"
                             ReferenceA4="ReferenceA4" />

            <div class="start-stop">
                @if (!AudioCapture.IsListening)
                {
                    <button class="btn-start" @onclick="StartListening">
                        <span class="btn-icon">ðŸŽµ</span>
                        Start Tuning
                    </button>
                }
                else
                {
                    <button class="btn-stop" @onclick="StopListening">
                        Stop
                    </button>
                }
            </div>
        }
    </main>

    <footer class="tuner-footer">
        <span>No ads. No tracking. Just tuning.</span>
    </footer>
</div>

@code {
    // Settings
    private int ReferenceA4 { get; set; } = 440;
    private string SelectedInstrumentName { get; set; } = "Cello";
    private InstrumentDefinition _selectedInstrument = InstrumentDefinition.Cello;

    // State
    private NoteInfo? _currentNote;
    private bool _isDetecting;
    private bool _isSupported = true;
    private double _smoothedCents;

    // Smoothing buffer
    private readonly Queue<double> _centsHistory = new();
    private const int SmoothingWindow = 5;

    private bool CanIncrementPitch => ReferenceA4 < 446;
    private bool CanDecrementPitch => ReferenceA4 > 438;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Restore saved preferences
            var savedInstrument = await LocalStorage.GetInstrumentAsync();
            if (savedInstrument is not null && InstrumentDefinition.All.Any(i => i.Name == savedInstrument))
            {
                SelectedInstrumentName = savedInstrument;
                _selectedInstrument = InstrumentDefinition.All.First(i => i.Name == savedInstrument);
            }

            var savedPitch = await LocalStorage.GetReferenceA4Async();
            if (savedPitch is not null && savedPitch >= 438 && savedPitch <= 446)
            {
                ReferenceA4 = savedPitch.Value;
            }

            _isSupported = await AudioCapture.CheckSupportedAsync();
            StateHasChanged();
        }
    }

    private async Task StartListening()
    {
        try
        {
            AudioCapture.OnAudioDataReceived += ProcessAudioData;
            await AudioCapture.StartAsync();
            _isDetecting = true;
        }
        catch
        {
            _isDetecting = false;
            AudioCapture.OnAudioDataReceived -= ProcessAudioData;
        }
    }

    private async Task StopListening()
    {
        AudioCapture.OnAudioDataReceived -= ProcessAudioData;
        await AudioCapture.StopAsync();
        _isDetecting = false;
        _currentNote = null;
        _smoothedCents = 0;
        _centsHistory.Clear();
    }

    private void ProcessAudioData(float[] buffer)
    {
        var frequency = PitchDetector.DetectPitch(buffer, AudioCapture.SampleRate);

        if (frequency.HasValue)
        {
            var note = NoteMapper.Map(frequency.Value, ReferenceA4);

            _currentNote = note;

            // Smoothing
            _centsHistory.Enqueue(note.CentsOffset);
            while (_centsHistory.Count > SmoothingWindow)
            {
                _centsHistory.Dequeue();
            }

            _smoothedCents = _centsHistory.Average();
        }
        else
        {
            // No pitch detected â€” don't immediately clear; keep showing last note briefly
            // This prevents flickering during brief silences
        }

        InvokeAsync(StateHasChanged);
    }

    private async Task OnInstrumentChanged()
    {
        _selectedInstrument = InstrumentDefinition.All.First(i => i.Name == SelectedInstrumentName);
        await LocalStorage.SetInstrumentAsync(SelectedInstrumentName);
    }

    private async Task OnInstrumentPickerChanged(string name)
    {
        SelectedInstrumentName = name;
        await OnInstrumentChanged();
    }

    private async Task IncrementPitch()
    {
        if (CanIncrementPitch)
        {
            ReferenceA4++;
            await LocalStorage.SetReferenceA4Async(ReferenceA4);
        }
    }

    private async Task DecrementPitch()
    {
        if (CanDecrementPitch)
        {
            ReferenceA4--;
            await LocalStorage.SetReferenceA4Async(ReferenceA4);
        }
    }

    public void Dispose()
    {
        AudioCapture.OnAudioDataReceived -= ProcessAudioData;
    }
}
